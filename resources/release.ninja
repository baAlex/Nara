
# "Works on my machine ¯\_(ツ)_/¯"

cflags = -O3 -flto -mtune=generic $
-I./source/lib-glad -I./source/lib-japan/include -I./source/lib-samplerate/src

lflags = -lglfw -lportaudio -lmruby -lm


rule ToHeader
 command = python3 ./source/c-ify.py $in $out

rule CompileC
 command = clang -fcolor-diagnostics $cflags -c $in -o $out

rule Link
 command = clang -fuse-ld=lld $in $lflags -o $out

rule CompileMRuby
 command = mrbc -o $out $in


# Inlined files
build ./build/release/engine/debug-fragment.c:   ToHeader ./source/engine/debug-fragment.glsl
build ./build/release/engine/debug-vertex.c:     ToHeader ./source/engine/debug-vertex.glsl
build ./build/release/engine/terrain-fragment.c: ToHeader ./source/engine/terrain-fragment.glsl
build ./build/release/engine/terrain-vertex.c:   ToHeader ./source/engine/terrain-vertex.glsl

build ./build/release/engine/debug-fragment.o:   CompileC ./build/release/engine/debug-fragment.c
build ./build/release/engine/debug-vertex.o:     CompileC ./build/release/engine/debug-vertex.c
build ./build/release/engine/terrain-fragment.o: CompileC ./build/release/engine/terrain-fragment.c
build ./build/release/engine/terrain-vertex.o:   CompileC ./build/release/engine/terrain-vertex.c

# Engine
build ./build/release/engine/context/context.o: CompileC ./source/engine/context/context.c
build ./build/release/engine/context/input.o:   CompileC ./source/engine/context/input.c
build ./build/release/engine/context/objects.o: CompileC ./source/engine/context/objects.c
build ./build/release/engine/context/state.o:   CompileC ./source/engine/context/state.c

build ./build/release/engine/mixer/dsp.o:    CompileC ./source/engine/mixer/dsp.c
build ./build/release/engine/mixer/mixer.o:  CompileC ./source/engine/mixer/mixer.c
build ./build/release/engine/mixer/sample.o: CompileC ./source/engine/mixer/sample.c

build ./build/release/engine/vm/definitions.o: CompileC ./source/engine/vm/definitions.c
build ./build/release/engine/vm/vm.o:          CompileC ./source/engine/vm/vm.c

build ./build/release/engine/misc.o:     CompileC ./source/engine/misc.c
build ./build/release/engine/nara.o:     CompileC ./source/engine/nara.c
build ./build/release/engine/nterrain.o: CompileC ./source/engine/nterrain.c
build ./build/release/engine/timer.o:    CompileC ./source/engine/timer.c

# Lib Glad
build ./build/release/lib-glad/glad.o: CompileC ./source/lib-glad/glad.c

# Lib Japan
build ./build/release/lib-japan/aabounding.o: CompileC ./source/lib-japan/source/aabounding.c
build ./build/release/lib-japan/buffer.o:     CompileC ./source/lib-japan/source/buffer.c
build ./build/release/lib-japan/dictionary.o: CompileC ./source/lib-japan/source/dictionary.c
build ./build/release/lib-japan/endianness.o: CompileC ./source/lib-japan/source/endianness.c
build ./build/release/lib-japan/list.o:       CompileC ./source/lib-japan/source/list.c
build ./build/release/lib-japan/matrix.o:     CompileC ./source/lib-japan/source/matrix.c
build ./build/release/lib-japan/status.o:     CompileC ./source/lib-japan/source/status.c
build ./build/release/lib-japan/tree.o:       CompileC ./source/lib-japan/source/tree.c
build ./build/release/lib-japan/utilities.o:  CompileC ./source/lib-japan/source/utilities.c
build ./build/release/lib-japan/vector.o:     CompileC ./source/lib-japan/source/vector.c

build ./build/release/lib-japan/configuration/configuration.o: CompileC ./source/lib-japan/source/configuration/configuration.c
build ./build/release/lib-japan/configuration/arguments.o:     CompileC ./source/lib-japan/source/configuration/arguments.c
build ./build/release/lib-japan/configuration/file.o:          CompileC ./source/lib-japan/source/configuration/file.c

build ./build/release/lib-japan/image/format-sgi.o: CompileC ./source/lib-japan/source/image/format-sgi.c
build ./build/release/lib-japan/image/image.o:      CompileC ./source/lib-japan/source/image/image.c

build ./build/release/lib-japan/sound/format-au.o:  CompileC ./source/lib-japan/source/sound/format-au.c
build ./build/release/lib-japan/sound/format-wav.o: CompileC ./source/lib-japan/source/sound/format-wav.c
build ./build/release/lib-japan/sound/laws.o:       CompileC ./source/lib-japan/source/sound/laws.c
build ./build/release/lib-japan/sound/sound.o:      CompileC ./source/lib-japan/source/sound/sound.c

# Lib Samplerate
build ./build/release/lib-samplerate/samplerate.o: CompileC ./source/lib-samplerate/src/samplerate.c
 cflags = -O3 -flto -mtune=generic $
 '-DPACKAGE="NaraLibSamplerate"' '-DVERSION="NaraCustom"' $
 '-DCPU_CLIPS_POSITIVE=0' '-DCPU_CLIPS_NEGATIVE=0'

build ./build/release/lib-samplerate/src_linear.o: CompileC ./source/lib-samplerate/src/src_linear.c
build ./build/release/lib-samplerate/src_sinc.o:   CompileC ./source/lib-samplerate/src/src_sinc.c
build ./build/release/lib-samplerate/src_zoh.o:    CompileC ./source/lib-samplerate/src/src_zoh.c

# Sdk
build ./build/release/sdk/erosion.o: CompileC ./source/sdk/erosion.c
build ./build/release/sdk/sdk.o:     CompileC ./source/sdk/sdk.c
build ./build/release/sdk/simplex.o: CompileC ./source/sdk/simplex.c

# Link Engine
build nara: Link $
./build/release/engine/context/context.o $
./build/release/engine/context/input.o $
./build/release/engine/context/objects.o $
./build/release/engine/context/state.o $
./build/release/engine/mixer/dsp.o $
./build/release/engine/mixer/mixer.o $
./build/release/engine/mixer/sample.o $
./build/release/engine/vm/definitions.o $
./build/release/engine/vm/vm.o $
./build/release/engine/misc.o $
./build/release/engine/nara.o $
./build/release/engine/nterrain.o $
./build/release/engine/timer.o $
./build/release/engine/debug-fragment.o $
./build/release/engine/debug-vertex.o $
./build/release/engine/terrain-fragment.o $
./build/release/engine/terrain-vertex.o $
./build/release/lib-glad/glad.o $
./build/release/lib-japan/aabounding.o $
./build/release/lib-japan/buffer.o $
./build/release/lib-japan/dictionary.o $
./build/release/lib-japan/endianness.o $
./build/release/lib-japan/list.o $
./build/release/lib-japan/matrix.o $
./build/release/lib-japan/status.o $
./build/release/lib-japan/tree.o $
./build/release/lib-japan/utilities.o $
./build/release/lib-japan/vector.o $
./build/release/lib-japan/configuration/configuration.o $
./build/release/lib-japan/configuration/arguments.o $
./build/release/lib-japan/configuration/file.o $
./build/release/lib-japan/image/format-sgi.o $
./build/release/lib-japan/image/image.o $
./build/release/lib-japan/sound/format-au.o $
./build/release/lib-japan/sound/format-wav.o $
./build/release/lib-japan/sound/laws.o $
./build/release/lib-japan/sound/sound.o $
./build/release/lib-samplerate/samplerate.o $
./build/release/lib-samplerate/src_linear.o $
./build/release/lib-samplerate/src_sinc.o $
./build/release/lib-samplerate/src_zoh.o

# Link Sdk
build sdk: Link $
./build/release/lib-japan/aabounding.o $
./build/release/lib-japan/buffer.o $
./build/release/lib-japan/dictionary.o $
./build/release/lib-japan/endianness.o $
./build/release/lib-japan/list.o $
./build/release/lib-japan/matrix.o $
./build/release/lib-japan/status.o $
./build/release/lib-japan/tree.o $
./build/release/lib-japan/utilities.o $
./build/release/lib-japan/vector.o $
./build/release/lib-japan/configuration/configuration.o $
./build/release/lib-japan/configuration/arguments.o $
./build/release/lib-japan/configuration/file.o $
./build/release/lib-japan/image/format-sgi.o $
./build/release/lib-japan/image/image.o $
./build/release/lib-japan/sound/format-au.o $
./build/release/lib-japan/sound/format-wav.o $
./build/release/lib-japan/sound/laws.o $
./build/release/lib-japan/sound/sound.o $
./build/release/sdk/erosion.o $
./build/release/sdk/sdk.o $
./build/release/sdk/simplex.o

# Compile/link game bytecode
build game.mrb: CompileMRuby $
./source/game/common.rb $
./source/game/camera.rb $
./source/game/player.rb $
./source/game/point.rb
